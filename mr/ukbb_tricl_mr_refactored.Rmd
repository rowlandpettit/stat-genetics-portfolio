---
title: "UKB ↔ TRICL Mendelian Randomization (Refactored)"
author: "Rowland Pettit"
date: "2021-03-16 (refactored)"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    code_folding: hide
---

# Purpose
This notebook documents a two-sample Mendelian randomization (MR) workflow linking UK Biobank (UKB) exposures to TRICL/OncoArray lung cancer outcomes. It is refactored for readability, reproducibility, and clarity. All data paths are placeholders; replace with your files or public resources.

# Setup
```{r setup, message=FALSE}
# Core packages
if (!requireNamespace("TwoSampleMR", quietly = TRUE)) install.packages("TwoSampleMR")
if (!requireNamespace("dplyr", quietly = TRUE)) install.packages("dplyr")
if (!requireNamespace("readr", quietly = TRUE)) install.packages("readr")
if (!requireNamespace("stringr", quietly = TRUE)) install.packages("stringr")
if (!requireNamespace("ggplot2", quietly = TRUE)) install.packages("ggplot2")
if (!requireNamespace("tibble", quietly = TRUE)) install.packages("tibble")

library(TwoSampleMR)
library(dplyr)
library(readr)
library(stringr)
library(ggplot2)
library(tibble)

# Optional: PRESSO, RAPS, contamination mixture, MVMR
# if (!requireNamespace("MRPRESSO", quietly = TRUE)) remotes::install_github("rondolab/MR-PRESSO")
# if (!requireNamespace("mr.raps", quietly = TRUE)) install.packages("mr.raps")
# if (!requireNamespace("MendelianRandomization", quietly = TRUE)) install.packages("MendelianRandomization")
# if (!requireNamespace("MVMR", quietly = TRUE)) remotes::install_github("WSpiller/MVMR")

# Optional OpenGWAS token for higher throughput
# Sys.setenv(IEU_OPENAPI_TOKEN = "<YOUR_TOKEN>")

# Reproducibility toggles
RUN_OPEN_GWAS <- FALSE   # set TRUE to fetch from OpenGWAS directly
RUN_PLOTS     <- TRUE
OUTDIR        <- "mr_outputs"
dir.create(OUTDIR, showWarnings = FALSE, recursive = TRUE)
```

# Inputs
- Exposures: OpenGWAS IDs from UKB/consortia (e.g., smoking traits, education, alcohol).
- Outcomes: TRICL/OncoArray lung cancer subtypes formatted for TwoSampleMR.

### Example OpenGWAS IDs (illustrative)
- Smoking: `ukb-b-7460` (Pack-years proportion), `ieu-b-4877` (Smoking initiation), `ieu-b-25` (Cigarettes/day)
- Alcohol: `ieu-b-73` (Drinks/week), `ukb-b-5174` (Beer+Cider)
- Education/Socioeconomic: `ieu-a-1239` (Years of schooling), `ukb-b-7408` (Household income)

```{r inputs, eval=FALSE}
# Example exposure IDs (replace as needed)
exposure_ids <- c(
  "ukb-b-7460",  # Pack years as proportion of lifespan
  "ieu-b-4877",  # Smoking initiation (GSCAN)
  "ieu-b-25",    # Cigarettes per day
  "ieu-b-73",    # Drinks per week
  "ieu-a-1239",  # Years of schooling
  "ukb-b-7408"   # Household income (pre-tax)
)

# Outcome formatted CSVs (placeholders) created previously with format_data()
outcome_files <- list(
  overall = "path/to/tricl_oncoarray_formatted/overall_formatted.csv",
  adeno   = "path/to/tricl_oncoarray_formatted/adeno_formatted.csv",
  small   = "path/to/tricl_oncoarray_formatted/small_formatted.csv",
  squam   = "path/to/tricl_oncoarray_formatted/squam_formatted.csv"
)

read_outcome <- function(file, label) {
  df <- readr::read_csv(file, show_col_types = FALSE)
  # Ensure columns match TwoSampleMR::read_outcome_data expectations
  # If you used TwoSampleMR::format_data(..., type="outcome"), it should already be compatible
  df$outcome <- label
  df
}

outcomes <- lapply(names(outcome_files), function(k) read_outcome(outcome_files[[k]], k))
names(outcomes) <- names(outcome_files)
```

### Dummy TRICL formatted outcome schema (example)
This is a minimal example of the columns typically produced by `TwoSampleMR::format_data(..., type = "outcome")` for case-control outcomes. Replace with real formatted files.

```{r dummy-schema, eval=FALSE}
example_outcome <- tibble::tibble(
  SNP = c("rs1001","rs1002","rs1003"),
  beta = c(0.05, -0.03, 0.02),            # log(OR)
  se = c(0.01, 0.015, 0.012),
  eaf = c(0.42, 0.35, 0.27),               # effect allele frequency
  effect_allele = c("A","G","T"),
  other_allele  = c("G","A","C"),
  pval = c(1e-6, 2e-4, 0.01),
  ncase = c(30000, 30000, 30000),
  ncontrol = c(500000, 500000, 500000),
  outcome = "overall"
)
readr::write_csv(example_outcome, "overall_formatted_example.csv")
```

# Utilities
```{r utils}
run_univariate_mr <- function(exposure_id, outcome_df, harmonise_action = 2) {
  message("Exposure: ", exposure_id, " | Outcome: ", unique(outcome_df$outcome))
  exp <- TwoSampleMR::extract_instruments(outcomes = exposure_id)
  if (nrow(exp) == 0) return(NULL)
  dat <- TwoSampleMR::harmonise_data(exp, outcome_df, action = harmonise_action)

  # Core estimators
  core_methods <- c("mr_ivw", "mr_egger_regression", "mr_weighted_median")
  mr_res <- TwoSampleMR::mr(dat, method_list = core_methods)

  # Diagnostics
  het   <- TwoSampleMR::mr_heterogeneity(dat, method_list = core_methods)
  pleio <- TwoSampleMR::mr_pleiotropy_test(dat)
  dirn  <- tryCatch(TwoSampleMR::directionality_test(dat), error = function(e) NULL)

  list(data = dat, mr = mr_res, het = het, pleio = pleio, directionality = dirn)
}

# Approximate R2 and F-statistics per SNP (case-control needs effective N if available)
compute_strength <- function(dat) {
  if (!all(c("beta.exposure","se.exposure","eaf.exposure","samplesize.exposure") %in% names(dat))) return(dat)
  dat$R2 <- with(dat, 2 * (beta.exposure^2) * eaf.exposure * (1 - eaf.exposure) /
                       (2 * (beta.exposure^2) * eaf.exposure * (1 - eaf.exposure) +
                        2 * (se.exposure^2) * samplesize.exposure * eaf.exposure * (1 - eaf.exposure)))
  dat$F_statistic <- with(dat, R2 * (samplesize.exposure - 2) / ((1 - R2)))
  dat
}

# Optional robust estimators (guarded)
run_optional_robust <- function(dat) {
  out_list <- list()
  if (requireNamespace("MRPRESSO", quietly = TRUE)) {
    out_list$presso <- tryCatch({
      MRPRESSO::mr_presso(BetaOutcome = "beta.outcome", BetaExposure = "beta.exposure",
                          SdOutcome = "se.outcome", SdExposure = "se.exposure",
                          OUTLIERtest = TRUE, DISTORTIONtest = TRUE, data = dat,
                          NbDistribution = 1000, SignifThreshold = 0.05)
    }, error = function(e) NULL)
  }
  if (requireNamespace("mr.raps", quietly = TRUE)) {
    out_list$raps <- tryCatch({
      mr.raps::mr.raps.simple(b_exp = dat$beta.exposure, b_out = dat$beta.outcome,
                              se_exp = dat$se.exposure, se_out = dat$se.outcome)
    }, error = function(e) NULL)
  }
  if (requireNamespace("MendelianRandomization", quietly = TRUE)) {
    out_list$conmix <- tryCatch({
      MendelianRandomization::mr_conmix(
        MendelianRandomization::mr_input(bx = dat$beta.exposure, bxse = dat$se.exposure,
                                         by = dat$beta.outcome, byse = dat$se.outcome)
      )
    }, error = function(e) NULL)
  }
  out_list
}

# Plot helpers
plot_all <- function(mr_res, dat, outdir, tag) {
  if (!RUN_PLOTS) return(invisible(NULL))
  try({
    sc <- TwoSampleMR::mr_scatter_plot(mr_res, dat)[[1]]
    ggsave(file.path(outdir, paste0("scatter_", tag, ".pdf")), sc, width = 6, height = 5)
  }, silent = TRUE)
  try({
    sng <- TwoSampleMR::mr_singlesnp(dat)
    fp <- TwoSampleMR::mr_forest_plot(sng)[[1]]
    ggsave(file.path(outdir, paste0("forest_", tag, ".pdf")), fp, width = 7, height = 8)
    fn <- TwoSampleMR::mr_funnel_plot(sng)[[1]]
    ggsave(file.path(outdir, paste0("funnel_", tag, ".pdf")), fn, width = 6, height = 5)
  }, silent = TRUE)
  try({
    loo <- TwoSampleMR::mr_leaveoneout(dat)
    lop <- TwoSampleMR::mr_leaveoneout_plot(loo)[[1]]
    ggsave(file.path(outdir, paste0("leaveoneout_", tag, ".pdf")), lop, width = 7, height = 6)
  }, silent = TRUE)
}
```

# Analysis: IVW / Egger / Weighted Median
```{r analysis, eval=FALSE}
results <- list()
for (eid in exposure_ids) {
  for (ok in names(outcomes)) {
    res <- tryCatch(run_univariate_mr(eid, outcomes[[ok]]), error = function(e) NULL)
    if (!is.null(res)) {
      # Strength and optional robust methods
      res$data <- compute_strength(res$data)
      res$robust <- run_optional_robust(res$data)

      key <- paste(eid, ok, sep = "::")
      results[[key]] <- res

      # Persist per-comparison outputs
      tag <- paste0(gsub("\\/|:", "_", eid), "__", ok)
      outdir <- file.path(OUTDIR, tag)
      dir.create(outdir, showWarnings = FALSE, recursive = TRUE)
      write_csv(res$data, file.path(outdir, "harmonised.csv"))
      write_csv(res$mr,   file.path(outdir, "mr_core.csv"))
      write_csv(res$het,  file.path(outdir, "heterogeneity.csv"))
      write_csv(res$pleio,file.path(outdir, "egger_intercept.csv"))
      if (!is.null(res$directionality)) write_csv(res$directionality, file.path(outdir, "directionality.csv"))

      # Optional robust outputs
      if (!is.null(res$robust$raps)) {
        raps_df <- tibble(method = "mr_raps_simple",
                          beta = res$robust$raps$beta.hat,
                          se = res$robust$raps$beta.se,
                          pval = res$robust$raps$beta.p.value)
        write_csv(raps_df, file.path(outdir, "mr_raps.csv"))
      }
      if (!is.null(res$robust$conmix)) {
        cm <- res$robust$conmix
        cm_df <- tibble(method = "mr_conmix",
                        beta = cm@Estimate[1],
                        se = (cm@CIUpper[1] - cm@CILower[1]) / 3.92,
                        pval = cm@Pvalue[1])
        write_csv(cm_df, file.path(outdir, "mr_conmix.csv"))
      }

      plot_all(res$mr, res$data, outdir, tag)
    }
  }
}

# Tidy and combine core MR results
mr_table <- bind_rows(lapply(names(results), function(k) {
  parts <- strsplit(k, "::")[[1]]
  exposure_id <- parts[1]; outcome <- parts[2]
  out <- results[[k]]$mr
  if (is.null(out)) return(NULL)
  out$id.exposure <- exposure_id
  out$outcome <- outcome
  out
}))

write_csv(mr_table, file.path(OUTDIR, "ukbb_tricl_univariate_mr.csv"))
```

# Robustness (optional)
- Heterogeneity: Cochran’s Q (see `mr_heterogeneity`).
- Pleiotropy: Egger intercept test (see `mr_pleiotropy_test`).
- Directionality: Steiger test (see `directionality_test`).
- Additional estimators: MR-PRESSO, RAPS, contamination mixture (shown below as commented code).

```{r optional_robustness, eval=FALSE}
# Example MR-PRESSO (requires MRPRESSO and R.utils if using timeouts)
# presso <- MRPRESSO::mr_presso(BetaOutcome = "beta.outcome", BetaExposure = "beta.exposure",
#                               SdOutcome = "se.outcome", SdExposure = "se.exposure",
#                               OUTLIERtest = TRUE, DISTORTIONtest = TRUE, data = results[[1]]$data,
#                               NbDistribution = 1000, SignifThreshold = 0.05)

# Example RAPS
# raps <- mr.raps::mr.raps.simple(b_exp = dat$beta.exposure, b_out = dat$beta.outcome,
#                                 se_exp = dat$se.exposure, se_out = dat$se.outcome)
```

# Multivariable MR (outline)
When multiple exposures are jointly modeled (e.g., smoking initiation and education), use multivariable MR to adjust for correlated pathways.

```{r mvmr_outline, eval=FALSE}
# exposures <- mv_extract_exposures(c("ieu-b-4877", "ieu-a-1239"))  # example: smoking + education
# mvdat <- mv_harmonise_data(exposures, outcomes[["overall"]], harmonise_strictness = 2)
# mv_ivw_res <- mv_ivw(mvdat, pval_threshold = 5e-8)
# mv_ivw_res$result
```

# Interpretation
- Prefer IVW when heterogeneity and pleiotropy are modest; cross-check with weighted median.
- Use Egger cautiously (low power, intercept diagnoses pleiotropy).
- Check Steiger for directionality and SNP strength (F-statistics) where possible.

# Provenance
This refactor retains the logic of the original UKB↔TRICL analysis while clarifying structure, adding guard rails, and documenting assumptions. Replace placeholders with your files/IDs and execute with `eval=TRUE`.

---

## Results interpretation checklist
- Instrument strength: compute approximate R2 and F-stat; avoid weak instruments.
- Harmonisation: allele alignment; remove ambiguous palindromic SNPs with high MAF.
- Heterogeneity: Cochran’s Q; investigate outliers if large.
- Pleiotropy: Egger intercept near 0; consider MR-PRESSO/median for robustness.
- Directionality: Steiger test supports exposure→outcome.
- Multiple testing: adjust p-values across traits/outcomes.
- Sample overlap: note potential bias in two-sample MR; prefer minimal overlap.
- Ancestry matching: exposures and outcomes from comparable ancestries.

---

## Computing environment
```{r session-info}
sessionInfo()
```

